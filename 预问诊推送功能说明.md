# 预问诊推送功能说明

## 功能概述

为了保护患者隐私并优化预问诊报告管理，我们对预问诊系统进行了重大升级：

### 核心改进
1. ✅ **隐私保护**：医生只能看到患者主动推送给自己的预问诊报告，不能查看所有患者报告
2. ✅ **主动推送**：患者生成报告后，可以搜索并选择特定医生进行推送
3. ✅ **报告管理**：医生可以删除已查看的报告，避免报告堆积

---

## 一、患者端功能

### 1.1 生成预问诊报告
患者完成预问诊问答后，系统会自动生成包含以下内容的结构化报告：
- 病情概述
- 关键信息
- 初步诊断考虑
- 建议检查项目
- 建议就诊科室
- 紧急程度评估
- 给医生的备注

### 1.2 推送给医生
在报告生成后，患者可以：

1. **搜索医生**
   - 在推送区域输入医生姓名或账号关键词
   - 按回车键或点击"搜索"按钮
   - 系统会列出所有匹配的医生账号

2. **选择推送**
   - 查看搜索结果中的医生信息（姓名、账号）
   - 点击医生卡片上的"推送"按钮
   - 系统确认推送成功后，该医生即可查看此报告

3. **推送限制**
   - 同一报告可以推送给多位不同医生
   - 已推送给某位医生的报告不能重复推送
   - 必须登录后才能推送报告

### 1.3 操作流程
```
患者登录 → 智能预问诊 → 填写主诉 → 回答问题 → 生成报告 → 搜索医生 → 推送报告
```

---

## 二、医生端功能

### 2.1 查看推送报告
医生登录后，在"医生端·结构化病历"页面：

1. **加载报告**
   - 点击"加载预问诊"按钮
   - 系统加载所有患者推送给该医生的预问诊报告
   - 只显示状态为"active"的报告（未删除的）

2. **报告列表显示**
   每条报告显示：
   - 患者姓名（带用户图标）
   - 紧急程度标签（颜色编码：非紧急-绿色、一般-蓝色、紧急-橙色、危重-红色）
   - 主诉内容
   - 创建时间
   - 推送时间

### 2.2 报告操作

#### 查看详情
- 点击报告卡片主体区域
- 弹出详细模态框，显示完整的预问诊信息
- 包括：主诉、紧急程度、病情概述、关键信息、初步诊断、建议检查、建议科室、医生备注、完整问诊记录

#### 填入病历
- 点击"填入病历"按钮
- 自动提取预问诊的关键信息
- 填充到"病情摘要"输入框
- 医生可在此基础上进行补充和修改

#### 删除报告
- 点击"删除"按钮（红色）
- 确认删除操作
- 报告被标记为"deleted"状态
- 从医生的报告列表中移除
- **注意**：删除后无法恢复，但原始报告仍保存在患者档案中

### 2.3 操作流程
```
医生登录 → 医生端病历页面 → 加载预问诊 → 查看报告 → 填入病历/删除
```

---

## 三、技术实现

### 3.1 后端API

#### 搜索医生账号
```
GET /api/doctors/search?keyword={关键词}
返回：匹配的医生列表（仅返回role="doctor"的用户）
```

#### 推送预问诊报告
```
POST /api/pre-consultation/push
参数：
  - doctor_username: 医生账号
  - report_id: 报告ID
验证：
  - 患者必须登录
  - 医生账号必须存在且角色为"doctor"
  - 报告必须属于该患者
  - 不能重复推送给同一医生
```

#### 获取推送的报告（医生端）
```
GET /api/doctors/pre-consultation/reports
返回：推送给当前医生的所有active状态报告
验证：
  - 必须登录
  - 角色必须为"doctor"
```

#### 删除推送的报告
```
DELETE /api/doctors/pre-consultation/reports/{push_id}
操作：将推送记录状态改为"deleted"
验证：
  - 必须登录且为医生角色
  - 只能删除推送给自己的报告
```

### 3.2 数据存储

#### pre_consultation_pushes.json
```json
{
  "pushes": [
    {
      "push_id": "唯一推送ID",
      "report_id": "报告ID",
      "patient_username": "患者账号",
      "patient_name": "患者姓名",
      "doctor_username": "医生账号",
      "doctor_name": "医生姓名",
      "pushed_at": "推送时间",
      "status": "active|deleted",
      "report_data": {
        "完整报告数据"
      }
    }
  ]
}
```

#### 状态说明
- **active**: 活跃状态，医生可查看
- **deleted**: 已删除，不再显示给医生

### 3.3 前端实现

#### 患者端（pre_consultation.js）
- `searchDoctors()`: 搜索医生
- `displayDoctorSearchResults()`: 显示搜索结果
- `pushReportToDoctor()`: 推送报告给医生

#### 医生端（pre_consultation.js）
- `loadPatientPreConsultation()`: 加载推送的报告
- `displayDoctorPreConsultationList()`: 显示报告列表
- `viewDoctorPreConsultationDetailByContent()`: 查看报告详情
- `deleteDoctorPreConsultationReport()`: 删除报告

---

## 四、权限和安全

### 4.1 权限控制
- ✅ 患者只能推送自己的报告
- ✅ 患者可以将同一报告推送给多位医生
- ✅ 医生只能查看推送给自己的报告
- ✅ 医生只能删除推送给自己的报告
- ✅ 所有操作都需要登录验证

### 4.2 数据安全
- ✅ 报告数据存储在患者自己的健康档案中
- ✅ 推送记录独立存储，包含报告副本
- ✅ 医生删除不影响患者档案中的原始报告
- ✅ 防止重复推送同一报告给同一医生

---

## 五、用户体验优化

### 5.1 视觉设计
- 🎨 推送区域采用蓝色渐变背景，突出功能
- 🎨 紧急程度用不同颜色标签标识
- 🎨 患者姓名旁显示用户图标
- 🎨 删除按钮采用红色，提示危险操作

### 5.2 交互优化
- ⚡ 支持回车键快速搜索
- ⚡ 推送后自动清空搜索结果
- ⚡ 删除前弹出确认对话框
- ⚡ 所有操作都有实时反馈提示

### 5.3 信息提示
- ℹ️ 搜索中显示加载动画
- ℹ️ 无结果时显示友好提示
- ✅ 成功操作显示绿色通知
- ❌ 错误操作显示红色提示
- ⚠️ 警告信息显示橙色提示

---

## 六、使用场景

### 场景1：急诊患者
```
患者发烧咳嗽 → 完成预问诊 → 系统判断"紧急" → 
搜索急诊医生 → 推送报告 → 医生快速了解病情 → 提前准备
```

### 场景2：专科就诊
```
患者特定症状 → 完成预问诊 → 系统推荐"心内科" → 
搜索心内科医生 → 推送报告 → 医生提前评估 → 安排检查
```

### 场景3：多次就诊
```
患者复诊 → 推送给之前的医生 → 医生查看历史 → 
对比病情变化 → 调整治疗方案
```

### 场景4：医生转诊
```
全科医生初诊 → 判断需要专科 → 患者推送给专科医生 → 
专科医生了解初诊情况 → 更精准诊断
```

---

## 七、注意事项

### 7.1 使用须知
1. 预问诊报告仅供参考，不能代替医生的专业诊断
2. 推送前请确认选择了正确的医生
3. 已推送的报告不能撤回，但可由医生删除
4. 医生删除报告不会影响患者档案中的原始报告

### 7.2 测试账号
为了测试推送功能，需要：
1. 创建至少一个医生角色的测试账号
2. 创建一个患者角色的测试账号
3. 患者完成预问诊生成报告
4. 患者搜索并推送给医生
5. 医生登录查看推送的报告

### 7.3 角色设置
在用户注册时，可以选择角色：
- `user`: 普通用户/患者（默认）
- `doctor`: 医生

医生账号可以：
- 接收患者推送的预问诊报告
- 使用医生端结构化病历功能
- 管理（查看、删除）推送的报告

---

## 八、未来优化方向

### 8.1 功能增强
- 📱 消息通知：推送后通知医生
- 📊 统计分析：医生查看报告统计
- 🏷️ 报告标签：医生可给报告添加标签
- 📝 医生回复：医生可对报告进行回复
- 🔍 高级搜索：按科室、医院等筛选医生

### 8.2 体验优化
- 💬 实时通讯：患者和医生在线沟通
- 📅 预约挂号：推送后直接预约
- 🔔 提醒功能：就诊前提醒
- 📈 进度跟踪：查看报告处理状态

---

## 总结

通过本次升级，预问诊系统实现了：
- ✅ **隐私保护**：医生只能看到推送给自己的报告
- ✅ **主动选择**：患者自主选择要推送的医生
- ✅ **灵活管理**：医生可删除已查看的报告
- ✅ **高效协作**：加快患者和医生之间的信息传递

这个系统既保护了患者隐私，又提高了就诊效率，为智慧医疗提供了更好的支持！

