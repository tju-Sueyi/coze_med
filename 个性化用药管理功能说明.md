# 个性化用药管理功能说明

## 功能概述

个性化用药管理是智慧AI医疗网站的核心功能之一，旨在帮助用户科学管理日常用药，提高用药依从性，确保用药安全。

## 主要功能

### 1. 💊 我的用药
用户可以全面管理自己的用药记录：

#### 功能特性：
- **添加用药记录**：记录药品名称、剂量、服用频率、疗程等详细信息
- **用药分类**：支持西药、中药、营养品等分类
- **状态管理**：
  - 使用中（active）：正在服用的药物
  - 已完成（completed）：疗程已结束
  - 已停用（stopped）：因医嘱或其他原因停用
- **快速操作**：
  - 一键记录服药
  - 编辑用药信息
  - 标记完成/停用
  - 删除记录

#### 记录信息：
- 药品名称*（必填）
- 剂量（如：100mg）
- 服用频率（如：每日3次）
- 疗程（如：7天）
- 开始日期
- 药物分类
- 开药医生
- 备注信息

### 2. ⏰ 服药提醒
智能提醒功能帮助用户按时服药：

#### 功能特性：
- **灵活设置**：
  - 选择关联的药物
  - 设置提醒时间
  - 选择提醒日期（每天/工作日/周末）
- **开关控制**：随时启用或禁用提醒
- **多个提醒**：同一药物可设置多个提醒时间

#### 提醒设置：
- 关联药品*（必选）
- 提醒时间*（必填，如：08:00）
- 提醒频率（每天/工作日/周末）
- 启用状态（开关控制）

### 3. 📝 服药记录
详细记录每次服药情况：

#### 功能特性：
- **快速记录**：从用药列表一键记录
- **详细记录**：通过表单记录详细信息
- **历史查看**：查看所有历史服药记录
- **筛选功能**：按药物、日期筛选记录

#### 记录信息：
- 药品名称*（必选）
- 服药时间*（必填）
- 服用剂量
- 备注（如：饭后服用、感觉等）

### 4. 🤖 AI智能分析
基于通义千问大模型的专业用药分析：

#### 分析内容：
1. **总体评估**
   - 用药方案的总体评价
   - 合理性分析

2. **药物相互作用**
   - 检测药物间的相互作用
   - 标注严重程度（高/中/低）
   - 提供详细说明

3. **安全警告**
   - 用药安全注意事项
   - 潜在风险提示
   - 禁忌症提醒

4. **用药建议**
   - 专业用药建议
   - 优化方案推荐
   - 注意事项提醒

#### 使用方法：
1. 确保已添加用药记录（状态为"使用中"）
2. 点击"开始分析"按钮
3. AI将自动分析当前活跃的用药
4. 查看详细分析报告

### 5. 📊 用药统计
可视化展示用药依从性：

#### 统计指标：
- **用药种类**：当前正在使用的药物数量
- **应服次数**：根据频率计算的应服药次数
- **已服次数**：实际记录的服药次数
- **依从性**：服药依从性百分比

#### 依从性评价：
- ≥80%：优秀，请继续保持
- 60-79%：一般，建议设置更多提醒
- <60%：较低，请务必按医嘱规律服药

#### 统计周期：
- 默认统计近7天
- 实时更新

## 技术架构

### 后端（backend_server.py）

#### API接口：

1. **用药记录管理**
   - `GET /api/medications` - 获取用药列表
   - `POST /api/medications` - 添加用药记录
   - `PUT /api/medications/<id>` - 更新用药记录
   - `DELETE /api/medications/<id>` - 删除用药记录

2. **服药提醒**
   - `GET /api/medications/reminders` - 获取提醒列表
   - `POST /api/medications/reminders` - 添加提醒
   - `PUT /api/medications/reminders/<id>` - 更新提醒
   - `DELETE /api/medications/reminders/<id>` - 删除提醒

3. **服药记录**
   - `GET /api/medications/intake-records` - 获取服药记录
   - `POST /api/medications/intake-records` - 记录服药

4. **统计分析**
   - `GET /api/medications/adherence-stats` - 获取依从性统计
   - `POST /api/medications/ai-analyze` - AI分析用药

### 核心模块（medication_management.py）

#### MedicationManager 类：

主要方法：
```python
# 用药记录
add_medication(username, medication_data)
get_user_medications(username, status)
update_medication(username, medication_id, update_data)
delete_medication(username, medication_id)

# 服药提醒
add_reminder(username, reminder_data)
get_user_reminders(username)
update_reminder(username, reminder_id, update_data)
delete_reminder(username, reminder_id)

# 服药记录
record_intake(username, intake_data)
get_intake_records(username, medication_id, start_date, end_date)

# 统计分析
get_adherence_stats(username, days)
```

### 前端

#### 文件结构：
- `medication.html` - 主界面
- `medication.js` - 交互逻辑

#### 主要功能：
- 标签式导航切换
- 模态框表单交互
- 异步数据加载
- 响应式布局

### 数据存储

#### 数据文件：
1. `data/medications.json` - 用药记录
2. `data/medication_reminders.json` - 服药提醒
3. `data/medication_intake_records.json` - 服药记录

#### 数据格式：

**用药记录**：
```json
{
  "medications": {
    "username": [
      {
        "id": "uuid",
        "name": "药品名称",
        "dosage": "100mg",
        "frequency": "每日3次",
        "duration": "7天",
        "start_date": "2025-01-01",
        "category": "西药",
        "prescribing_doctor": "张医生",
        "notes": "饭后服用",
        "status": "active",
        "created_at": "2025-01-01T00:00:00",
        "updated_at": "2025-01-01T00:00:00"
      }
    ]
  }
}
```

**服药提醒**：
```json
{
  "reminders": {
    "username": [
      {
        "id": "uuid",
        "medication_id": "med_uuid",
        "medication_name": "药品名称",
        "time": "08:00",
        "days": ["每天"],
        "enabled": true,
        "created_at": "2025-01-01T00:00:00"
      }
    ]
  }
}
```

**服药记录**：
```json
{
  "records": {
    "username": [
      {
        "id": "uuid",
        "medication_id": "med_uuid",
        "medication_name": "药品名称",
        "taken_at": "2025-01-01T08:00:00",
        "dosage": "100mg",
        "notes": "饭后服用",
        "created_at": "2025-01-01T08:00:00"
      }
    ]
  }
}
```

## 使用流程

### 1. 添加用药记录
1. 进入"我的用药"标签
2. 点击"添加用药"按钮
3. 填写药品信息
4. 保存记录

### 2. 设置提醒
1. 进入"服药提醒"标签
2. 点击"添加提醒"按钮
3. 选择药品和时间
4. 保存提醒
5. 使用开关控制启用/禁用

### 3. 记录服药
**方法一：快速记录**
- 在"我的用药"列表中点击"记录服药"按钮

**方法二：详细记录**
1. 进入"服药记录"标签
2. 点击"记录服药"按钮
3. 填写详细信息
4. 保存记录

### 4. AI分析
1. 确保有活跃用药记录
2. 进入"AI分析"标签
3. 点击"开始分析"按钮
4. 等待AI分析完成
5. 查看分析报告

### 5. 查看统计
- 进入"用药统计"标签
- 自动显示依从性统计
- 根据评价调整用药习惯

## 注意事项

### 使用建议：
1. **及时记录**：每次服药后及时记录，确保统计准确
2. **设置提醒**：为重要药物设置多个提醒时间
3. **定期分析**：定期使用AI分析功能检查用药安全
4. **遵医嘱**：所有用药应遵循医生建议
5. **更新状态**：疗程结束后及时更新用药状态

### 安全提示：
1. ⚠️ **本功能仅供参考**：不能替代专业医疗建议
2. ⚠️ **谨慎用药**：任何用药变更应咨询医生
3. ⚠️ **注意相互作用**：AI分析结果供参考，重要决策请咨询医生
4. ⚠️ **过敏史**：请在备注中记录药物过敏史
5. ⚠️ **不良反应**：出现不良反应应立即停药并就医

## 特色亮点

1. **智能AI分析**
   - 基于通义千问大模型
   - 专业的药物相互作用检测
   - 个性化用药建议

2. **用户友好**
   - 简洁直观的界面
   - 一键快速操作
   - 响应式设计

3. **数据可视化**
   - 直观的统计图表
   - 依从性评价
   - 用药趋势分析

4. **灵活提醒**
   - 多样化提醒设置
   - 开关控制
   - 自定义时间

5. **完整记录**
   - 详细的用药信息
   - 历史记录查询
   - 筛选和搜索

## 后续优化方向

1. **功能增强**
   - 药品数据库集成
   - 扫码识别药品
   - 用药日历视图
   - 导出用药报告

2. **提醒增强**
   - 浏览器推送通知
   - 微信提醒（如果集成）
   - 语音提醒

3. **分析增强**
   - 更详细的相互作用数据库
   - 个性化健康建议
   - 用药趋势预测

4. **社交功能**
   - 用药经验分享
   - 药物评价系统

5. **医生协同**
   - 医生查看患者用药
   - 在线调整用药方案
   - 用药依从性报告

## 技术支持

如有问题或建议，请联系开发团队。

---

**版本**：v1.0  
**更新日期**：2025-10-28  
**开发团队**：智慧AI医疗

