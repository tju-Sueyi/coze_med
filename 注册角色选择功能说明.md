# 注册角色选择功能说明

## 📋 功能概述

在用户注册时，现在可以选择自己的角色：
- 🧑‍🤝‍🧑 **患者**：使用诊疗服务
- 👨‍⚕️ **医生**：提供诊疗服务

---

## ✨ 新增功能

### 1. 注册界面改进

#### 角色选择卡片
- 两个醒目的角色选项卡
- 图标 + 文字描述
- 点击即可选择
- 视觉反馈（高亮、阴影、渐变背景）

#### 交互效果
- ✅ 悬停高亮
- ✅ 选中蓝色渐变背景
- ✅ 蓝色边框 + 光晕效果
- ✅ 平滑过渡动画

---

## 👥 角色区别

### 患者角色 (user)
**权限**：
- ✅ 使用智能预问诊
- ✅ 推送报告给医生
- ✅ AI健康咨询
- ✅ 中医诊断
- ✅ 拍照分析
- ✅ 社区交流
- ✅ 管理健康档案

**特点**：
- 默认角色
- 面向普通用户
- 接受医疗服务

---

### 医生角色 (doctor)
**权限**：
- ✅ 所有患者功能
- ✅ **接收患者推送的预问诊报告**
- ✅ **使用医生端结构化病历**
- ✅ **生成治疗方案**
- ✅ 删除推送的报告
- ✅ 将预问诊信息填入病历

**特点**：
- 专业医疗人员
- 提供诊疗服务
- 接收患者推送

---

## 🚀 使用流程

### 注册新账号

1. **打开注册页面**
   ```
   点击导航栏"登录" → 点击"去注册"
   ```

2. **填写基本信息**
   - 输入用户名（至少3个字符）
   - 输入密码（至少6位）

3. **选择角色**
   - 点击"患者"卡片（默认选中）
   - 或点击"医生"卡片
   - 选中的卡片会高亮显示

4. **完成注册**
   - 点击"注册"按钮
   - 看到成功提示，显示您的角色
   - 自动跳转到登录页面

5. **登录使用**
   - 输入刚才注册的用户名和密码
   - 登录后即可使用相应角色的功能

---

## 🎯 测试预问诊推送功能

### 准备工作

1. **注册患者账号**
   ```
   用户名：patient01
   密码：123456
   角色：患者
   ```

2. **注册医生账号**
   ```
   用户名：doctor01
   密码：123456
   角色：医生
   ```

### 测试流程

#### 步骤1：患者生成预问诊报告
```
1. 以患者账号登录
2. 点击"智能预问诊"
3. 输入主诉（例如：发烧头痛3天）
4. 回答AI生成的问题
5. 提交后生成预问诊报告
```

#### 步骤2：推送给医生
```
1. 在报告页面找到"推送给医生"区域
2. 输入医生账号或姓名（例如：doctor01）
3. 点击"搜索"按钮
4. 在搜索结果中点击"推送"按钮
5. 看到成功提示
```

#### 步骤3：医生查看报告
```
1. 退出患者账号
2. 以医生账号登录
3. 进入"医生端·结构化病历"页面
4. 点击"加载预问诊"按钮
5. 看到患者推送的报告
6. 可以点击查看详情、填入病历或删除
```

---

## 💡 界面展示

### 注册页面

```
┌─────────────────────────────────┐
│        注册              [X]     │
├─────────────────────────────────┤
│                                 │
│  用户名 ___________________     │
│                                 │
│  密码   ___________________     │
│                                 │
│  ┌───────────────────────────┐ │
│  │  选择您的角色              │ │
│  │                           │ │
│  │  ┌──────┐    ┌──────┐    │ │
│  │  │ 🧑‍🤝‍🧑  │    │ 👨‍⚕️  │    │ │
│  │  │ 患者  │    │ 医生  │    │ │
│  │  │使用诊疗│    │提供诊疗│    │ │
│  │  └──────┘    └──────┘    │ │
│  └───────────────────────────┘ │
│                                 │
│          [   注册   ]           │
│                                 │
│  已有账号？去登录               │
└─────────────────────────────────┘
```

---

## 🔧 技术实现

### 前端（index.html）

#### HTML结构
```html
<div class="modal-body">
    <!-- 角色选择 -->
    <div style="background: #f8fafc; ...">
        <label>选择您的角色</label>
        <div style="display: flex; gap: 12px;">
            <!-- 患者选项 -->
            <label class="role-option">
                <input type="radio" name="register-role" value="user" checked />
                <div>🧑‍🤝‍🧑</div>
                <div>患者</div>
                <div>使用诊疗服务</div>
            </label>
            
            <!-- 医生选项 -->
            <label class="role-option">
                <input type="radio" name="register-role" value="doctor" />
                <div>👨‍⚕️</div>
                <div>医生</div>
                <div>提供诊疗服务</div>
            </label>
        </div>
    </div>
</div>
```

#### CSS样式
```css
.role-option {
    transition: all 0.2s ease;
}

.role-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #3b82f6;
}

.role-option:has(input:checked) {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
```

### 前端（script.js）

#### 注册函数修改
```javascript
async function submitRegister() {
    // ... 获取用户名和密码
    
    // 获取选中的角色
    const roleRadios = document.querySelectorAll('input[name="register-role"]');
    let role = 'user';
    for (const radio of roleRadios) {
        if (radio.checked) {
            role = radio.value;
            break;
        }
    }
    
    // 发送注册请求（包含角色）
    const res = await fetch('/api/auth/register', {
        method: 'POST',
        body: JSON.stringify({ 
            username: u, 
            password: p, 
            role: role 
        })
    });
    
    // 显示成功提示（包含角色）
    const roleText = role === 'doctor' ? '医生' : '患者';
    showNotification(`注册成功！您的角色：${roleText}`, 'success');
}
```

#### 视觉更新函数
```javascript
function updateRoleSelection(radio) {
    // 重置所有选项样式
    const allOptions = document.querySelectorAll('.role-option');
    allOptions.forEach(option => {
        option.style.borderColor = '#cbd5e1';
        option.style.background = 'white';
        option.style.boxShadow = 'none';
    });
    
    // 高亮选中选项
    if (radio && radio.checked) {
        const selectedOption = radio.closest('.role-option');
        selectedOption.style.borderColor = '#3b82f6';
        selectedOption.style.background = 'linear-gradient(...)';
        selectedOption.style.boxShadow = '...';
    }
}
```

### 后端（backend_server.py）

#### 注册接口修改
```python
@app.route('/api/auth/register', methods=['POST'])
def auth_register():
    data = parse_json_request()
    username = data.get('username')
    password = data.get('password')
    role = data.get('role', 'user')  # 获取角色，默认患者
    
    # 验证角色值
    if role not in ['user', 'doctor']:
        role = 'user'
    
    # 保存用户信息（包含角色）
    users[username] = {
        "password_hash": hash_password(password),
        "role": role,
        "active_record_id": None
    }
    
    return jsonify({
        "success": True,
        "username": username,
        "role": role,  # 返回角色信息
        "session_id": session_id
    })
```

---

## ⚠️ 注意事项

### 1. 角色不可更改
- 注册时选定的角色无法修改
- 如需更换角色，需注册新账号

### 2. 默认角色
- 如果未选择或选择失败，默认为"患者"
- 旧账号（升级前注册）默认为"患者"

### 3. 医生权限
- 医生账号拥有患者的所有权限
- 额外拥有接收预问诊报告等功能
- 不会限制医生使用患者功能

### 4. 数据结构
用户数据保存在 `data/users.json`：
```json
{
  "users": {
    "patient01": {
      "password_hash": "...",
      "role": "user",
      "active_record_id": null
    },
    "doctor01": {
      "password_hash": "...",
      "role": "doctor",
      "active_record_id": null
    }
  }
}
```

---

## 🐛 故障排查

### 问题1：选择角色后没有高亮
**原因**：CSS可能未加载
**解决**：刷新页面（Ctrl+F5）

### 问题2：注册后角色显示错误
**原因**：后端未更新
**解决**：
```cmd
1. 运行 stop.bat
2. 运行 start.bat
```

### 问题3：医生看不到推送的报告
**原因**：可能注册时角色选择错误
**解决**：
1. 查看 `data/users.json`
2. 确认 `role` 字段为 `"doctor"`
3. 如不是，需重新注册医生账号

---

## 🎉 更新内容总结

### ✅ 已完成
1. 注册界面添加角色选择
2. 美观的卡片式选项
3. 交互动画和高亮效果
4. 前端获取并提交角色
5. 后端保存和验证角色
6. 注册成功提示显示角色

### 🎯 应用场景
- 患者注册后可推送预问诊给医生
- 医生注册后可接收患者推送
- 角色明确，权限清晰

---

## 📞 使用帮助

遇到问题？
1. 查看本文档的"故障排查"部分
2. 确认服务正在运行（运行 `status.bat`）
3. 检查浏览器控制台错误信息
4. 查看 `backend.log` 日志文件

---

**更新时间**：2025-10-22  
**版本**：v1.0

