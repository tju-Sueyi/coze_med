# 预问诊推送功能测试指南

## 🎯 测试目标

验证以下功能是否正常：
1. ✅ 患者可以搜索到医生账号
2. ✅ 患者可以推送预问诊报告给医生
3. ✅ 医生只能看到推送给自己的报告
4. ✅ 医生可以查看、填入病历、删除报告

---

## 📋 前置准备

### 1. 确认服务运行
```cmd
.\status.bat
```

应该看到：
- ✅ 后端服务端口 (5000) 正在监听
- ✅ 前端服务端口 (8000) 正在监听

### 2. 确认测试账号

**医生账号**：yys4（角色：医生）
**患者账号**：yys、yys1、yys3 等（角色：患者）

---

## 🧪 测试流程

### 测试一：患者生成并推送预问诊报告

#### 步骤1：患者登录
1. 打开浏览器：http://localhost:8000
2. 点击右上角"登录"
3. 输入患者账号（例如：yys）
4. 输入密码
5. 点击"登录"

#### 步骤2：生成预问诊报告
1. 在首页找到"智能预问诊"服务卡片
2. 点击"开始预问诊"按钮
3. 在主诉输入框输入症状，例如：
   ```
   发烧3天，头痛，体温38.5℃
   ```
4. 点击"提交主诉"
5. AI会生成一系列问题，逐一回答，例如：
   - 问：什么时候开始发烧的？
   - 答：3天前晚上开始的
   - 问：还有其他症状吗？
   - 答：有点咳嗽和流鼻涕
6. 回答完所有问题后，点击"提交答案"
7. 等待生成预问诊报告

#### 步骤3：搜索医生并推送
1. 在生成的预问诊报告页面，向下滚动
2. 找到"推送给医生"区域
3. 在搜索框输入：`yys4`
4. 点击"🔍 搜索"按钮
5. **预期结果**：
   ```
   找到 1 位医生
   [医生] yys4   [推送] 按钮
   ```
6. 点击"推送"按钮
7. **预期结果**：
   ```
   ✅ 推送成功！报告已发送给 yys4
   ```

---

### 测试二：医生接收并查看报告

#### 步骤1：切换到医生账号
1. 点击右上角用户名，退出登录
2. 重新登录，使用医生账号：
   - 用户名：yys4
   - 密码：（您设置的密码）
3. 登录成功

#### 步骤2：查看推送的报告
1. 在导航栏点击"服务"→"医生端·结构化病历"
2. 在页面右侧找到"患者预问诊报告"区域
3. 点击"🔄 加载预问诊"按钮
4. **预期结果**：
   ```
   显示推送的报告列表，包含：
   - 患者姓名：yys（或推送者的用户名）
   - 主诉：发烧3天，头痛，体温38.5℃
   - 推送时间
   - 操作按钮：查看详情、填入病历、删除
   ```

#### 步骤3：查看详情
1. 点击某条报告的"查看详情"按钮
2. **预期结果**：
   ```
   弹出详情窗口，显示：
   - 主诉
   - AI问答记录
   - 智能分析
   - 建议
   - 紧急程度标记
   ```

#### 步骤4：填入病历
1. 关闭详情窗口
2. 点击"填入病历"按钮
3. **预期结果**：
   ```
   预问诊内容自动填充到病历输入框
   ```

#### 步骤5：删除报告
1. 点击某条报告的"删除"按钮
2. 确认删除
3. **预期结果**：
   ```
   ✅ 删除成功
   报告从列表中消失
   ```

---

### 测试三：验证隔离性（重要！）

#### 目的：确保医生只能看到推送给自己的报告

#### 步骤1：创建另一个医生账号
1. 退出登录
2. 点击"注册"
3. 注册新医生：
   - 用户名：doctor02
   - 密码：123456
   - 角色：选择"医生"（点击医生卡片）
4. 注册成功

#### 步骤2：验证隔离
1. 用 doctor02 登录
2. 进入"医生端·结构化病历"
3. 点击"加载预问诊"
4. **预期结果**：
   ```
   应该显示：暂无推送的预问诊报告
   或者只显示推送给 doctor02 的报告
   不应该看到推送给 yys4 的报告
   ```

---

### 测试四：注册时角色选择

#### 测试新注册流程

1. 退出登录
2. 点击"注册"按钮
3. 输入用户名：`test_patient`
4. 输入密码：`123456`
5. **观察角色选择区域**：
   - 应该看到两个卡片
   - 左边：🧑‍🤝‍🧑 患者（默认选中，蓝色高亮）
   - 右边：👨‍⚕️ 医生
6. **点击医生卡片**：
   - 医生卡片应该高亮（蓝色边框+渐变背景）
   - 患者卡片恢复默认样式
7. **再点击患者卡片**：
   - 患者卡片重新高亮
   - 医生卡片恢复默认
8. 选择"医生"，点击"注册"
9. **预期结果**：
   ```
   ✅ 注册成功！您的角色：医生
   ```

#### 验证角色保存
1. 用新注册的账号登录
2. 切换到患者账号
3. 进入预问诊，生成报告
4. 搜索刚注册的医生账号
5. 应该能搜索到并成功推送

---

## ✅ 测试检查清单

### 基本功能
- [ ] 患者可以生成预问诊报告
- [ ] 可以搜索医生账号
- [ ] 搜索结果只显示医生角色的用户
- [ ] 可以成功推送报告
- [ ] 推送成功后有提示

### 医生功能
- [ ] 医生可以看到推送给自己的报告
- [ ] 报告列表显示患者姓名和时间
- [ ] 可以查看报告详情
- [ ] 可以将报告填入病历
- [ ] 可以删除报告

### 角色隔离
- [ ] 医生A看不到推送给医生B的报告
- [ ] 患者搜索时只能找到医生账号
- [ ] 患者搜索不到其他患者账号

### 注册功能
- [ ] 注册页面显示角色选择
- [ ] 角色卡片可以点击切换
- [ ] 选中的卡片有视觉高亮
- [ ] 注册成功后提示显示角色
- [ ] 角色正确保存到数据库

---

## 🐛 常见问题

### 问题1：搜索不到医生
**原因**：账号角色可能是患者
**解决**：
```cmd
python set_user_role.py <医生账号名> doctor
```

### 问题2：医生看到所有人的报告
**原因**：后端代码可能未更新
**解决**：
```cmd
.\stop.bat
.\start.bat
```

### 问题3：注册时没有角色选择
**原因**：前端代码未更新，浏览器缓存
**解决**：
1. 按 Ctrl+F5 强制刷新
2. 或清除浏览器缓存

### 问题4：注册后角色没保存
**原因**：后端未重启
**解决**：
```cmd
.\restart.bat
```

---

## 📊 预期数据结构

### users.json
```json
{
  "users": {
    "yys4": {
      "password_hash": "...",
      "role": "doctor",
      "active_record_id": null
    },
    "yys": {
      "password_hash": "...",
      "role": "user",
      "active_record_id": "..."
    }
  }
}
```

### pre_consultation_pushes.json
```json
{
  "pushes": [
    {
      "push_id": "unique-id-123",
      "report_id": "report-id-456",
      "patient_username": "yys",
      "doctor_username": "yys4",
      "content": {
        "chief_complaint": "发烧3天...",
        "qa_history": [...],
        "summary": {...}
      },
      "push_time": "2025-10-22 14:30:00"
    }
  ]
}
```

---

## 📞 测试完成后

### 成功标准
所有检查清单项都打勾 ✅

### 报告问题
如果测试失败，请提供：
1. 失败的步骤编号
2. 预期结果
3. 实际结果
4. 错误提示（如有）
5. 浏览器控制台错误（按F12查看）

---

**测试时间**：建议预留 15-20 分钟  
**更新时间**：2025-10-22  
**版本**：v1.0

