# 用药批量识别功能 - 快速测试指南

## 🎯 测试目标

验证以下功能是否正常工作：
1. ✅ AI能否识别照片中的**多个**药品
2. ✅ 前端能否正确展示多个识别结果
3. ✅ 用户能否编辑每个药品的信息
4. ✅ 用户能否删除不需要的药品
5. ✅ 能否批量保存所有识别的药品

## 📋 准备工作

### 1. 后端启动
```bash
cd D:\医疗AI\coze本地化
python backend_server.py
```
等待看到：
```
Running on http://127.0.0.1:5000
用药管理模块已加载
```

### 2. 清空浏览器缓存
- 按 `Ctrl+Shift+Delete`
- 勾选"Cookie 和其他网站数据"
- 点击"清除数据"

### 3. 硬刷新页面
- 按 `Ctrl+F5`
- 等待页面完全加载

### 4. 准备测试照片
需要包含多个药品信息的照片，可以：
- 📸 使用手机拍摄多个药品包装
- 📝 或准备一张包含多个药品的合照

## 🧪 测试用例

### 📌 测试1：识别单个药品

**步骤：**
1. 登录用药管理
2. 选择一个档案
3. 点击"➕ 添加用药"
4. 点击"📷 拍照识别"
5. 拍照一个药品包装
6. 等待识别完成

**预期结果：**
- ✅ 显示"成功识别 1 个药品"
- ✅ 显示1张卡片
- ✅ 卡片包含识别到的信息

**检查点：**
```
成功识别 1 个药品
┌─────────────────────────┐
│ 药品 1                  │
├─────────────────────────┤
│ 药品名称: [布洛芬]      │
│ 剂量: [100mg]          │
│ 频率: [每日3次]        │
│ 疗程: [7天]            │
│ 分类: [西药]           │
│ 备注: [饭后服用]       │
└─────────────────────────┘
✅ 全部保存  ❌ 清空
```

---

### 📌 测试2：识别多个药品

**步骤：**
1. 登录用药管理
2. 选择一个档案
3. 点击"➕ 添加用药"
4. 点击"🖼️ 上传照片"
5. 选择包含**3个或以上**药品的照片
6. 等待识别完成

**预期结果：**
- ✅ 显示"成功识别 N 个药品"
- ✅ 显示多张卡片（每个药品一张）
- ✅ 每张卡片可以独立编辑
- ✅ 可以滚动查看所有卡片

**检查点：**
```
成功识别 3 个药品
┌─────────────────────────┐      ┌─────────────────────────┐
│ 药品 1                  │      │ 药品 2                  │
├─────────────────────────┤      ├─────────────────────────┤
│ 药品名称: [布洛芬]      │      │ 药品名称: [维生素D]     │
│ 剂量: [100mg]          │      │ 剂量: [1000IU]         │
│ ... (其他字段)  │      │ ... (其他字段)  │
│ 🗑️ 删除                │      │ 🗑️ 删除                │
└─────────────────────────┘      └─────────────────────────┘
         (向下滚动查看更多)
✅ 全部保存  ❌ 清空
```

---

### 📌 测试3：编辑识别结果

**步骤：**
1. 完成识别（2-3个药品）
2. 修改第一个药品的名称
3. 修改第二个药品的剂量
4. 不修改第三个药品

**预期结果：**
- ✅ 修改的字段被保存
- ✅ 未修改的字段保持原样
- ✅ 可以按Tab键快速编辑

**测试步骤：**
```
1. 在"药品名称"输入框中修改：
   "布洛芬" → "布洛芬片"
   
2. 在"剂量"输入框中修改：
   "100mg" → "200mg"
   
3. 按Tab键或点击其他区域确认编辑
```

---

### 📌 测试4：删除识别结果

**步骤：**
1. 识别3个药品
2. 点击第2个药品的"🗑️ 删除"按钮
3. 观察界面变化

**预期结果：**
- ✅ 第2个卡片消失
- ✅ 第3个卡片变成第2个
- ✅ 卡片编号自动更新
- ✅ 删除后显示"成功识别 2 个药品"

**检查点：**
```
删除前：
✅ 成功识别 3 个药品
药品 1 | 药品 2 | 药品 3

点击 药品2 的删除按钮 🗑️

删除后：
✅ 成功识别 2 个药品
药品 1 | 药品 2（原来的药品3）
```

---

### 📌 测试5：批量保存

**步骤：**
1. 识别2-3个药品
2. 修改所有药品的名称（确保不为空）
3. 点击"✅ 全部保存"按钮
4. 等待保存完成

**预期结果：**
- ✅ 显示"✅ 成功保存 N 个药品"
- ✅ 识别窗口自动关闭
- ✅ 返回正常的"添加用药"界面
- ✅ 在"我的用药"列表中看到新添加的药品

**检查点：**
```
保存前：
✅ 全部保存  ❌ 清空

点击 全部保存

系统响应：
✅ 成功保存 3 个药品

随后：
- 识别界面关闭
- 自动返回"我的用药"列表
- 新药品出现在列表顶部
```

---

### 📌 测试6：清空识别结果

**步骤：**
1. 识别2-3个药品
2. 点击"❌ 清空"按钮
3. 观察界面变化

**预期结果：**
- ✅ 所有卡片清空
- ✅ 识别状态清空
- ✅ 照片预览消失
- ✅ 可以重新进行识别

**检查点：**
```
清空前：
✅ 成功识别 3 个药品
[3张卡片]
✅ 全部保存  ❌ 清空

点击 清空

清空后：
[识别界面为空]
可以重新点击"📷 拍照识别"或"🖼️ 上传照片"
```

---

### 📌 测试7：错误处理

**步骤：**
1. 尝试保存时，将某个药品的名称清空
2. 点击"✅ 全部保存"

**预期结果：**
- ✅ 显示错误提示："请填写所有药品的名称"
- ✅ 不进行保存
- ✅ 继续留在编辑界面

**检查点：**
```
操作：删除某个药品的名称，点击保存

系统提示：
❌ 请填写所有药品的名称

结果：
- 保存被阻止
- 继续在编辑界面
- 用户可以修正信息后重试
```

---

### 📌 测试8：识别失败处理

**步骤：**
1. 上传一张不包含药品的照片（如风景照）
2. 等待识别

**预期结果：**
- ✅ 显示"⚠️ 未识别到药品信息"或"❌ 识别失败"
- ✅ 不显示卡片列表
- ✅ 用户可以重新上传照片

**检查点：**
```
上传风景照

系统响应：
⚠️ 未识别到药品信息，请手动填写

结果：
- 没有卡片显示
- 可以点击"📷 拍照识别"或"🖼️ 上传照片"重新尝试
```

---

## 📊 完整测试流程示例

### 示例流程：识别并保存3种常见药品

```
1. 【准备】
   - 准备包含"布洛芬""维生素D""钙片"的照片
   - 启动后端，刷新页面

2. 【识别】
   点击"添加用药" → "上传照片" → 选择照片
   
3. 【验证识别】
   期望看到：✅ 成功识别 3 个药品
   显示3张卡片：
   - 布洛芬 100mg
   - 维生素D 1000IU
   - 钙片 500mg

4. 【编辑】
   - 修正"布洛芬"剂量：100mg → 200mg
   - 验证"维生素D"分类：营养品 ✓
   - 删除"钙片"（假设识别错误）

5. 【验证编辑后】
   期望看到：✅ 成功识别 2 个药品
   显示2张卡片：
   - 布洛芬 200mg （已修改）
   - 维生素D 1000IU

6. 【保存】
   点击"✅ 全部保存"

7. 【验证保存】
   期望看到：✅ 成功保存 2 个药品
   
8. 【验证数据】
   在"我的用药"列表中查看：
   - ✅ 布洛芬 200mg（新增）
   - ✅ 维生素D 1000IU（新增）
```

---

## 🔍 调试技巧

### 检查浏览器Console
1. 按 `F12` 打开开发者工具
2. 切换到"Console"标签
3. 查看是否有错误信息

**常见错误排查：**
```javascript
// 错误1：API返回格式错误
console.log('数据:', data);  // 检查data.medication_list是否存在

// 错误2：没有保存record_id
console.log('当前档案:', currentRecordFilter);

// 错误3：编辑没有保存
console.log('识别的药品:', recognizedMedications);
```

### 检查网络请求
1. 按 `F12` → "Network"标签
2. 重新进行识别
3. 查看`recognize-photo`请求：
   - Status: 200 ✅
   - Response: 包含`medication_list`数组

---

## ✅ 通过标准

测试通过需要满足：
- ✅ 所有8个测试用例均通过
- ✅ 没有JavaScript错误
- ✅ 药品正确保存到数据库
- ✅ 不同档案的药品正确隔离
- ✅ 识别和编辑流程顺畅

---

## 🐛 常见问题

### Q: 识别出错怎么办？
**A:** 
1. 检查照片清晰度
2. 确保药品名称清晰可见
3. 尝试重新拍照或上传

### Q: 编辑后信息没保存？
**A:**
1. 确保输入框失去焦点（点击其他地方）
2. 刷新页面再试
3. 检查console是否有错误

### Q: 批量保存失败？
**A:**
1. 检查所有药品都有名称
2. 确保记录了所需权限
3. 查看后端日志是否有错误

---

## 📝 测试记录表

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 识别单个药品 | ⏳ | |
| 识别多个药品 | ⏳ | |
| 编辑识别结果 | ⏳ | |
| 删除识别结果 | ⏳ | |
| 批量保存 | ⏳ | |
| 清空识别结果 | ⏳ | |
| 错误处理 | ⏳ | |
| 识别失败处理 | ⏳ | |

---

**完成所有测试后，功能即可上线使用！** 🎉
